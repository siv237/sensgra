# Sensgra

Система мониторинга показаний системных сенсоров с долгосрочным хранением данных и визуализацией.

## Возможности

- Автоматическое обнаружение и мониторинг всех доступных сенсоров
- Адаптивное создание баз данных для новых сенсоров
- Интерактивные графики с гибкой настройкой отображения
- Эффективное хранение истории с автоматическим усреднением (RRDtool)
- Сохранение пользовательских настроек отображения

## Компоненты

Система состоит из двух независимых компонентов:

1. **sensor-logger.py** - демон для сбора данных:
   - Автоматически находит все доступные сенсоры через lm-sensors
   - При появлении новых сенсоров создаёт для них базы данных
   - Работает полностью автономно без настройки
   - Собирает данные каждые 5 секунд
   - Автоматическое усреднение старых данных

2. **app.py** - веб-интерфейс для визуализации:
   - Строит интерактивные графики на основе RRD
   - Позволяет включать/отключать отображение сенсоров
   - Запоминает настройки отображения
   - Гибкая группировка по типам данных

## Хранение данных

Для каждого сенсора автоматически создаётся RRD база с четырьмя уровнями детализации:

- 7 дней с шагом 30 секунд (20160 точек)
- 30 дней с шагом 5 минут (8640 точек)
- 1 год с шагом 30 минут (17520 точек)
- 4 года с шагом 2 часа (17520 точек)

Это позволяет хранить:
- Детальные данные за последнюю неделю
- Подробную историю за месяц
- Средние значения за год
- Долгосрочную историю за 4 года

При этом размер базы остаётся постоянным независимо от времени работы.

## Настройка отображения

### sensor_names.json

Файл `static/sensor_names.json` определяет настройки отображения сенсоров в веб-интерфейсе:

```json
{
    "devices": {
        "amdgpu-pci-0400": {           // ID устройства
            "имя": "Видеокарта AMD",    // Имя для отображения
            "sensors": {
                "edge": {               // ID сенсора
                    "имя": "Температура GPU",  // Имя для графика
                    "тип": "температура"       // Тип для группировки
                }
            }
        }
    },
    "graphs": {                         // Настройки групп графиков
        "температура": {
            "имя": "Температуры",
            "единица": "°C"
        }
    }
}
```

- Настройки влияют только на отображение в веб-интерфейсе
- Логгер работает независимо от этого файла
- Сенсоры группируются по типу для удобства просмотра
- Можно задавать свои имена для устройств и сенсоров
- Выбор отображаемых сенсоров сохраняется в браузере

## Требования

- Python 3.11+
- lm-sensors
- RRDtool с библиотеками разработки
- Современный веб-браузер

## Установка

1. Установите системные зависимости:
```bash
# Debian/Ubuntu
sudo apt install python3-venv lm-sensors rrdtool librrd-dev

# Arch Linux
sudo pacman -S python lm_sensors rrdtool

# Fedora
sudo dnf install python3 lm_sensors rrdtool rrdtool-devel
```

2. Настройте и проверьте lm-sensors:
```bash
# Автоматическое обнаружение сенсоров
sudo sensors-detect --auto

# Проверка что сенсоры определились
sensors -j
```

3. Клонируйте репозиторий и перейдите в директорию:
```bash
git clone https://github.com/yourusername/sensgra.git
cd sensgra
```

4. Запустите скрипт установки и запуска:
```bash
# Создаст venv, установит зависимости и запустит логгер
./run.sh
```

После запуска логгер будет:
- Автоматически находить все доступные сенсоры
- Создавать RRD базы для новых сенсоров
- Собирать данные каждые 5 секунд
- Хранить историю с автоматическим усреднением

## Автозапуск через systemd

1. Создайте файл systemd сервиса:
```bash
sudo nano /etc/systemd/system/sensgra.service
```

2. Добавьте следующее содержимое (измените пути на свои):
```ini
[Unit]
Description=Sensgra - System Sensors Logger
After=network.target

[Service]
Type=simple
User=YOUR_USERNAME
WorkingDirectory=/path/to/sensgra
ExecStart=/path/to/sensgra/run.sh
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

3. Включите и запустите сервис:
```bash
sudo systemctl daemon-reload
sudo systemctl enable sensgra
sudo systemctl start sensgra
```

4. Проверьте статус:
```bash
sudo systemctl status sensgra
```

## Структура проекта

- `sensor-logger.py` - демон сбора данных
- `app.py` - веб-сервер Flask
- `templates/` - шаблоны страниц
- `static/` - статические файлы (JS, CSS)
- `rrd/` - директория с RRD базами данных
