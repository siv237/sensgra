# Sensgra

Система мониторинга показаний системных сенсоров с долгосрочным хранением данных и визуализацией.

## Возможности

- Автоматическое обнаружение и мониторинг всех доступных сенсоров
- Адаптивное создание баз данных для новых сенсоров
- Интерактивные графики с гибкой настройкой отображения
- Эффективное хранение истории с автоматическим усреднением (RRDtool)
- Сохранение пользовательских настроек отображения

## Компоненты

Система состоит из двух независимых компонентов:

1. **sensor-logger.py** - демон для сбора данных:
   - Автоматически находит все доступные сенсоры через lm-sensors
   - При появлении новых сенсоров создаёт для них базы данных
   - Работает полностью автономно без настройки
   - Собирает данные каждые 5 секунд
   - Автоматическое усреднение старых данных

2. **app.py** - веб-интерфейс для визуализации:
   - Строит интерактивные графики на основе RRD
   - Позволяет включать/отключать отображение сенсоров
   - Запоминает настройки отображения
   - Гибкая группировка по типам данных

## Хранение данных

Для каждого сенсора автоматически создаётся RRD база с четырьмя уровнями детализации:

- 7 дней с шагом 30 секунд (20160 точек)
- 30 дней с шагом 5 минут (8640 точек)
- 1 год с шагом 30 минут (17520 точек)
- 4 года с шагом 2 часа (17520 точек)

Это позволяет хранить:
- Детальные данные за последнюю неделю
- Подробную историю за месяц
- Средние значения за год
- Долгосрочную историю за 4 года

При этом размер базы остаётся постоянным независимо от времени работы.

## Настройка отображения

### sensor_names.json

Файл `static/sensor_names.json` определяет настройки отображения сенсоров в веб-интерфейсе:

```json
{
    "devices": {
        "amdgpu-pci-0400": {           // ID устройства
            "имя": "Видеокарта AMD",    // Имя для отображения
            "sensors": {
                "edge": {               // ID сенсора
                    "имя": "Температура GPU",  // Имя для графика
                    "тип": "температура"       // Тип для группировки
                }
            }
        }
    },
    "graphs": {                         // Настройки групп графиков
        "температура": {
            "имя": "Температуры",
            "единица": "°C"
        }
    }
}
```

- Настройки влияют только на отображение в веб-интерфейсе
- Логгер работает независимо от этого файла
- Сенсоры группируются по типу для удобства просмотра
- Можно задавать свои имена для устройств и сенсоров
- Выбор отображаемых сенсоров сохраняется в браузере

## Требования

- Python 3.11+
- lm-sensors
- RRDtool
- Современный веб-браузер

## Установка

1. Установите системные зависимости:
```bash
sudo apt install python3-rrdtool lm-sensors
```

2. Создайте виртуальное окружение и активируйте его:
```bash
python3 -m venv venv
source venv/bin/activate
```

3. Установите зависимости Python:
```bash
pip install -r requirements.txt
```

4. Убедитесь что lm-sensors установлен и настроен:
```bash
sensors -j
```

## Автозапуск службы

Для автоматического запуска логгера и веб-сервера при старте системы:

```bash
sudo ln -sf $(pwd)/sensors-plot.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable sensors-plot
sudo systemctl start sensors-plot
```

Проверка статуса:
```bash
sudo systemctl status sensors-plot
```

## Структура проекта

- `sensor-logger.py` - демон сбора данных
- `app.py` - веб-сервер Flask
- `templates/` - шаблоны страниц
- `static/` - статические файлы (JS, CSS)
- `rrd/` - директория с RRD базами данных
